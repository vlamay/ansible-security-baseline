---
name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible ansible-lint yamllint
      
      - name: Run yamllint
        run: |
          yamllint .
        continue-on-error: true
      
      - name: Run ansible-lint
        run: |
          ansible-lint
  
  molecule:
    name: Molecule Test
    runs-on: ubuntu-latest
    needs: lint
    
    strategy:
      matrix:
        distro:
          - ubuntu2204
        # Add more distros as needed:
        # - ubuntu2004
        # - ubuntu2404
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install molecule molecule-plugins[docker] docker ansible-core>=2.12
      
      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install community.general
          ansible-galaxy collection install ansible.posix
      
      - name: Run Molecule tests
        run: |
          molecule test
        env:
          PY_COLORS: '1'
          ANSIBLE_FORCE_COLOR: '1'
  
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: molecule
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core>=2.12
      
      - name: Run syntax check
        run: |
          ansible-playbook site.yml --syntax-check
      
      - name: Display role info
        run: |
          ansible-galaxy role info . || echo "Role info not available"

  release:
    name: Release to Ansible Galaxy
    runs-on: ubuntu-latest
    needs: [lint, molecule]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core
      
      - name: Publish to Ansible Galaxy
        run: |
          ansible-galaxy role import --api-key ${{ secrets.GALAXY_API_KEY }} $(echo ${{ github.repository }} | cut -d/ -f1) $(echo ${{ github.repository }} | cut -d/ -f2)
        if: env.GALAXY_API_KEY != ''
        env:
          GALAXY_API_KEY: ${{ secrets.GALAXY_API_KEY }}
