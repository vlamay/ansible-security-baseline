---
# Password Policy Configuration Tasks

- name: Install PAM pwquality module
  ansible.builtin.package:
    name: libpam-pwquality
    state: present
  when: ansible_os_family == "Debian"
  tags:
    - packages

- name: Configure password quality requirements
  ansible.builtin.lineinfile:
    path: /etc/security/pwquality.conf
    regexp: "^{{ item.key }}"
    line: "{{ item.key }} = {{ item.value }}"
    state: present
    create: yes
    mode: '0644'
  loop:
    - { key: "minlen", value: "{{ security_baseline_password_min_length }}" }
    - { key: "minclass", value: "{{ security_baseline_password_min_classes }}" }
    - { key: "dcredit", value: "-1" }  # At least 1 digit
    - { key: "ucredit", value: "-1" }  # At least 1 uppercase
    - { key: "lcredit", value: "-1" }  # At least 1 lowercase
    - { key: "ocredit", value: "-1" }  # At least 1 special char
    - { key: "maxrepeat", value: "3" }  # Max 3 repeated chars
    - { key: "usercheck", value: "1" }  # Check against username
    - { key: "enforcing", value: "1" }  # Enforce for root too
  tags:
    - pam
    - config

- name: Configure password remember (history)
  ansible.builtin.lineinfile:
    path: "{{ security_baseline_pam_password_config }}"
    regexp: "^password.*pam_pwhistory.so"
    line: "password required pam_pwhistory.so remember={{ security_baseline_password_history_remember }} use_authtok"
    insertafter: "^password.*pam_unix.so"
    state: present
  tags:
    - pam
    - config

- name: Configure password aging in login.defs
  ansible.builtin.lineinfile:
    path: "{{ security_baseline_login_defs_path }}"
    regexp: "^{{ item.key }}"
    line: "{{ item.key }}\t{{ item.value }}"
    state: present
  loop:
    - { key: "PASS_MAX_DAYS", value: "{{ security_baseline_password_max_age }}" }
    - { key: "PASS_MIN_DAYS", value: "{{ security_baseline_password_min_age }}" }
    - { key: "PASS_WARN_AGE", value: "{{ security_baseline_password_warn_age }}" }
  tags:
    - login-defs
    - config

- name: Configure account lockout for failed login attempts (preauth)
  ansible.builtin.lineinfile:
    path: "{{ security_baseline_pam_auth_config }}"
    regexp: "^auth.*pam_faillock.so.*preauth"
    line: "auth required pam_faillock.so preauth silent deny=5 unlock_time=900"
    insertbefore: "^auth.*pam_unix.so"
    state: present
  tags:
    - pam
    - lockout

- name: Configure faillock for account lockout (authfail)
  ansible.builtin.lineinfile:
    path: "{{ security_baseline_pam_auth_config }}"
    regexp: "^auth.*pam_faillock.so.*authfail"
    line: "auth required pam_faillock.so authfail deny=5 unlock_time=900"
    insertafter: "^auth.*pam_unix.so"
    state: present
  tags:
    - pam
    - lockout

- name: Set umask for users
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: "^UMASK"
    line: "UMASK\t\t027"
    state: present
  tags:
    - umask
    - permissions

- name: Configure umask in /etc/profile
  ansible.builtin.lineinfile:
    path: /etc/profile
    regexp: "^umask"
    line: "umask 027"
    state: present
  tags:
    - umask
    - permissions

- name: Set timeout for inactive sessions
  ansible.builtin.lineinfile:
    path: /etc/profile.d/tmout.sh
    line: "readonly TMOUT=900 ; export TMOUT"
    create: yes
    mode: '0644'
  tags:
    - timeout
    - session

- name: Ensure root password is set (if in production)
  ansible.builtin.debug:
    msg: "REMINDER: Ensure root account has a strong password set manually"
  when: security_baseline_environment == 'production'
  tags:
    - reminder
