---
# System Hardening Tasks (sysctl)

- name: Apply sysctl security parameters
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: "{{ security_baseline_sysctl_config }}"
    reload: yes
  loop:
    # Network security - IP forwarding
    - { key: 'net.ipv4.ip_forward', value: "{{ '0' if security_baseline_disable_ip_forwarding else '1' }}" }
    - { key: 'net.ipv6.conf.all.forwarding', value: "{{ '0' if security_baseline_disable_ip_forwarding else '1' }}" }

    # Network security - SYN flood protection
    - { key: 'net.ipv4.tcp_syncookies', value: "{{ '1' if security_baseline_enable_syn_cookies else '0' }}" }
    - { key: 'net.ipv4.tcp_max_syn_backlog', value: '2048' }
    - { key: 'net.ipv4.tcp_synack_retries', value: '2' }
    - { key: 'net.ipv4.tcp_syn_retries', value: '5' }

    # Network security - RP filter (source validation)
    - { key: 'net.ipv4.conf.all.rp_filter', value: "{{ '1' if security_baseline_enable_rp_filter else '0' }}" }
    - { key: 'net.ipv4.conf.default.rp_filter', value: "{{ '1' if security_baseline_enable_rp_filter else '0' }}" }

    # Network security - Disable source routing
    - { key: 'net.ipv4.conf.all.accept_source_route', value: "{{ '0' if security_baseline_disable_source_routing else '1' }}" }
    - { key: 'net.ipv4.conf.default.accept_source_route', value: "{{ '0' if security_baseline_disable_source_routing else '1' }}" }
    - { key: 'net.ipv6.conf.all.accept_source_route', value: "{{ '0' if security_baseline_disable_source_routing else '1' }}" }

    # Network security - Disable ICMP redirects
    - { key: 'net.ipv4.conf.all.send_redirects', value: "{{ '0' if security_baseline_disable_send_redirects else '1' }}" }
    - { key: 'net.ipv4.conf.default.send_redirects', value: "{{ '0' if security_baseline_disable_send_redirects else '1' }}" }
    - { key: 'net.ipv4.conf.all.accept_redirects', value: "{{ '0' if security_baseline_disable_accept_redirects else '1' }}" }
    - { key: 'net.ipv4.conf.default.accept_redirects', value: "{{ '0' if security_baseline_disable_accept_redirects else '1' }}" }
    - { key: 'net.ipv6.conf.all.accept_redirects', value: "{{ '0' if security_baseline_disable_accept_redirects else '1' }}" }
    - { key: 'net.ipv4.conf.all.secure_redirects', value: '0' }
    - { key: 'net.ipv4.conf.default.secure_redirects', value: '0' }

    # Network security - Ignore ICMP broadcasts
    - { key: 'net.ipv4.icmp_echo_ignore_broadcasts', value: "{{ '1' if security_baseline_ignore_icmp_broadcasts else '0' }}" }
    - { key: 'net.ipv4.icmp_ignore_bogus_error_responses', value: '1' }

    # Network security - Log martians
    - { key: 'net.ipv4.conf.all.log_martians', value: "{{ '1' if security_baseline_log_martians else '0' }}" }
    - { key: 'net.ipv4.conf.default.log_martians', value: "{{ '1' if security_baseline_log_martians else '0' }}" }

    # Kernel security - ASLR
    - { key: 'kernel.randomize_va_space', value: "{{ '2' if security_baseline_enable_aslr else '0' }}" }

    # Kernel security - Restrict dmesg
    - { key: 'kernel.dmesg_restrict', value: "{{ '1' if security_baseline_restrict_dmesg else '0' }}" }

    # Kernel security - Restrict kernel pointers
    - { key: 'kernel.kptr_restrict', value: "{{ '2' if security_baseline_restrict_kernel_pointers else '0' }}" }

    # Kernel security - Restrict core dumps
    - { key: 'fs.suid_dumpable', value: "{{ '0' if security_baseline_restrict_core_dumps else '2' }}" }

    # Kernel security - Ptrace scope
    - { key: 'kernel.yama.ptrace_scope', value: '1' }

    # Kernel security - ExecShield equivalent (if supported)
    - { key: 'kernel.exec-shield', value: '1' }

    # Network security - TCP timestamps
    - { key: 'net.ipv4.tcp_timestamps', value: '0' }

    # Network security - Time wait
    - { key: 'net.ipv4.tcp_fin_timeout', value: '15' }
    - { key: 'net.ipv4.tcp_keepalive_time', value: '1800' }
    - { key: 'net.ipv4.tcp_keepalive_probes', value: '5' }
    - { key: 'net.ipv4.tcp_keepalive_intvl', value: '15' }

  failed_when: false  # Some parameters may not be available on all systems
  notify: Reload sysctl
  tags:
    - sysctl
    - kernel
    - network

- name: Disable core dumps via limits
  ansible.builtin.lineinfile:
    path: /etc/security/limits.conf
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
  loop:
    - { regexp: '^\* hard core', line: '* hard core 0' }
    - { regexp: '^\* soft core', line: '* soft core 0' }
  when: security_baseline_restrict_core_dumps | default(true)
  tags:
    - limits
    - coredump

- name: Disable core dumps via sysctl
  ansible.builtin.copy:
    dest: /etc/sysctl.d/50-coredump.conf
    content: |
      # Disable core dumps
      kernel.core_pattern=|/bin/false
    mode: '0644'
  when: security_baseline_restrict_core_dumps | default(true)
  notify: Reload sysctl
  tags:
    - sysctl
    - coredump

- name: Disable USB storage (if configured)
  ansible.builtin.copy:
    dest: /etc/modprobe.d/disable-usb-storage.conf
    content: |
      # Disable USB storage devices
      install usb-storage /bin/true
      blacklist usb-storage
    mode: '0644'
  when: security_baseline_disable_usb_storage | default(false)
  tags:
    - usb
    - modprobe

- name: Disable Bluetooth (if configured)
  ansible.builtin.copy:
    dest: /etc/modprobe.d/disable-bluetooth.conf
    content: |
      # Disable Bluetooth
      install bluetooth /bin/true
      blacklist bluetooth
    mode: '0644'
  when: security_baseline_disable_bluetooth | default(false)
  tags:
    - bluetooth
    - modprobe

- name: Set secure permissions on sensitive files
  ansible.builtin.file:
    path: "{{ item.path }}"
    owner: root
    group: "{{ item.group | default('root') }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: '/etc/passwd', mode: '0644' }
    - { path: '/etc/shadow', mode: '0640', group: 'shadow' }
    - { path: '/etc/group', mode: '0644' }
    - { path: '/etc/gshadow', mode: '0640', group: 'shadow' }
    - { path: '/etc/sudoers', mode: '0440' }
    - { path: '/etc/ssh/sshd_config', mode: '0600' }
  failed_when: false
  tags:
    - permissions
    - files

- name: Ensure cron directories have proper permissions
  ansible.builtin.file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: '0700'
  loop:
    - /etc/cron.d
    - /etc/cron.daily
    - /etc/cron.hourly
    - /etc/cron.weekly
    - /etc/cron.monthly
  failed_when: false
  tags:
    - permissions
    - cron

- name: Restrict cron to root only
  ansible.builtin.copy:
    dest: /etc/cron.allow
    content: |
      root
    mode: '0600'
  tags:
    - cron
    - permissions

- name: Remove cron.deny if exists
  ansible.builtin.file:
    path: /etc/cron.deny
    state: absent
  tags:
    - cron
    - permissions
