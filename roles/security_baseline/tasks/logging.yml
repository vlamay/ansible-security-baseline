---
# Logging Configuration Tasks

- name: Ensure rsyslog is installed
  ansible.builtin.package:
    name: rsyslog
    state: present
  tags:
    - packages
    - logging

- name: Configure rsyslog for security logging
  ansible.builtin.copy:
    dest: /etc/rsyslog.d/50-security.conf
    content: |
      # Security Baseline Logging Configuration
      # Generated by Ansible
      
      # Log auth messages to dedicated file
      auth,authpriv.*                 /var/log/auth.log
      
      # Log sudo activity
      local2.*                        /var/log/sudo.log
      
      # Log kernel messages
      kern.*                          /var/log/kern.log
      
      # Log mail messages
      mail.*                          /var/log/mail.log
      
      # Emergency messages to all users
      *.emerg                         :omusrmsg:*
      
      # Log cron activity
      cron.*                          /var/log/cron.log
    mode: '0644'
  notify: Restart rsyslog service
  tags:
    - logging
    - rsyslog

- name: Configure remote syslog server (if configured)
  ansible.builtin.lineinfile:
    path: /etc/rsyslog.d/60-remote.conf
    line: "*.* @{{ security_baseline_remote_syslog_server }}"
    create: yes
    mode: '0644'
  when: security_baseline_remote_syslog_server | length > 0
  notify: Restart rsyslog service
  tags:
    - logging
    - remote

- name: Configure logrotate for security logs
  ansible.builtin.copy:
    dest: /etc/logrotate.d/security-baseline
    content: |
      /var/log/auth.log
      /var/log/sudo.log
      /var/log/kern.log
      /var/log/cron.log
      {
          weekly
          rotate {{ (security_baseline_log_retention_days / 7) | int }}
          compress
          delaycompress
          missingok
          notifempty
          create 0640 root adm
          sharedscripts
          postrotate
              /usr/lib/rsyslog/rsyslog-rotate
          endscript
      }
    mode: '0644'
  tags:
    - logging
    - logrotate

- name: Ensure log directories have correct permissions
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: adm
    mode: '0750'
  when: ansible_virtualization_type != 'docker'
  loop:
    - /var/log
    - /var/log/audit
  failed_when: false
  tags:
    - logging
    - permissions

- name: Set permissions on sensitive log files
  ansible.builtin.file:
    path: "{{ item }}"
    owner: root
    group: adm
    mode: '0640'
  loop:
    - /var/log/auth.log
    - /var/log/syslog
    - /var/log/kern.log
  failed_when: false
  tags:
    - logging
    - permissions

- name: Enable and start rsyslog service
  ansible.builtin.service:
    name: rsyslog
    state: started
    enabled: yes
  tags:
    - logging
    - service

- name: Install logwatch for log analysis
  ansible.builtin.package:
    name: logwatch
    state: present
  when: ansible_os_family == "Debian"
  tags:
    - packages
    - logging

- name: Configure logwatch
  ansible.builtin.copy:
    dest: /etc/logwatch/conf/logwatch.conf
    content: |
      # Logwatch Configuration
      # Generated by Ansible - Security Baseline
      
      LogDir = /var/log
      TmpDir = /var/cache/logwatch
      Output = stdout
      Format = text
      Encode = none
      MailTo = root
      MailFrom = Logwatch
      Range = yesterday
      Detail = Med
      Service = All
      Service = "-zz-network"
    mode: '0644'
  failed_when: false
  tags:
    - logging
    - logwatch
