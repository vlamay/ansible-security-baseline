# Fail2ban Configuration
# Generated by Ansible - Security Baseline Role
# Environment: {{ security_baseline_environment }}
# Generated: (Dynamic timestamp removed for idempotence)
#
# WARNING: This file is managed by Ansible. Local changes will be overwritten.

[DEFAULT]
# =============================================================================
# Global Settings
# =============================================================================

# Ban hosts for specified time (in seconds)
bantime = {{ security_baseline_fail2ban_bantime }}

# Time window to check for failures
findtime = {{ security_baseline_fail2ban_findtime }}

# Max retries before ban
maxretry = {{ security_baseline_fail2ban_maxretry }}

# Backend for monitoring logs
backend = {{ security_baseline_fail2ban_backend }}

# Email settings for notifications
destemail = {{ security_baseline_fail2ban_destemail }}
sender = {{ security_baseline_fail2ban_sender }}

# Action type
# action_   = ban only
# action_mw = ban + send email with whois info
# action_mwl = ban + send email with whois info + log lines
action = %({{ security_baseline_fail2ban_action }})s

# Ignore local addresses
ignoreip = 127.0.0.1/8 ::1

# Use iptables for banning
banaction = iptables-multiport
banaction_allports = iptables-allports

# Chain to add rules
chain = INPUT

# =============================================================================
# SSH Jail
# =============================================================================
[sshd]
enabled = true
port = {{ security_baseline_ssh_port }}
filter = sshd
logpath = %(sshd_log)s
maxretry = {{ security_baseline_fail2ban_maxretry }}
bantime = {{ security_baseline_fail2ban_bantime }}
findtime = {{ security_baseline_fail2ban_findtime }}

# Aggressive mode for SSH (detects more attack patterns)
mode = aggressive

# =============================================================================
# SSH DDOS protection
# =============================================================================
[sshd-ddos]
enabled = true
port = {{ security_baseline_ssh_port }}
filter = sshd-ddos
logpath = %(sshd_log)s
maxretry = 10
bantime = 3600
findtime = 600

# =============================================================================
# Recidive Jail (repeat offenders)
# =============================================================================
[recidive]
enabled = true
filter = recidive
logpath = /var/log/fail2ban.log
action = %(banaction_allports)s
bantime = 604800  # 1 week
findtime = 86400  # 1 day
maxretry = 3

# =============================================================================
# Additional Jails (enable as needed)
# =============================================================================

{% if 'nginx-http-auth' in security_baseline_fail2ban_jails %}
# Nginx HTTP Auth
[nginx-http-auth]
enabled = true
filter = nginx-http-auth
port = http,https
logpath = /var/log/nginx/error.log
maxretry = 5
{% endif %}

{% if 'apache-auth' in security_baseline_fail2ban_jails %}
# Apache Auth
[apache-auth]
enabled = true
port = http,https
logpath = %(apache_error_log)s
maxretry = 5
{% endif %}

{% if 'nginx-botsearch' in security_baseline_fail2ban_jails %}
# Nginx Bot Search (block scanners)
[nginx-botsearch]
enabled = true
filter = nginx-botsearch
port = http,https
logpath = /var/log/nginx/access.log
maxretry = 2
{% endif %}

{% if 'postfix' in security_baseline_fail2ban_jails %}
# Postfix SMTP
[postfix]
enabled = true
port = smtp,465,submission
logpath = %(postfix_log)s
{% endif %}

{% if 'dovecot' in security_baseline_fail2ban_jails %}
# Dovecot IMAP/POP3
[dovecot]
enabled = true
port = pop3,pop3s,imap,imaps,submission,465,sieve
logpath = %(dovecot_log)s
{% endif %}

# =============================================================================
# Custom Jails
# =============================================================================

# Add custom jails below this line
