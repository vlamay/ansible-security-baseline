# SSH Server Configuration
# Generated by Ansible - Security Baseline Role
# Environment: {{ security_baseline_environment }}
# Generated: {{ ansible_date_time.iso8601 }}
#
# WARNING: This file is managed by Ansible. Local changes will be overwritten.

# Port and Listen Address
Port {{ security_baseline_ssh_port }}
AddressFamily any
ListenAddress 0.0.0.0
ListenAddress ::

# =============================================================================
# Host Keys
# =============================================================================
HostKey /etc/ssh/ssh_host_ed25519_key
HostKey /etc/ssh/ssh_host_rsa_key
# ECDSA disabled for better security
# HostKey /etc/ssh/ssh_host_ecdsa_key

# =============================================================================
# Cryptography Configuration
# =============================================================================

# Key Exchange Algorithms (modern and secure)
KexAlgorithms {{ security_baseline_ssh_kex_algorithms | join(',') }}

# Ciphers (strong encryption only)
Ciphers {{ security_baseline_ssh_ciphers | join(',') }}

# Message Authentication Codes
MACs {{ security_baseline_ssh_macs | join(',') }}

# Host Key Algorithms
HostKeyAlgorithms {{ security_baseline_ssh_host_key_algorithms | join(',') }}

# =============================================================================
# Authentication Configuration
# =============================================================================

# Root login
PermitRootLogin {{ security_baseline_permit_root_login }}

# Password authentication
PasswordAuthentication {{ security_baseline_password_authentication }}
PermitEmptyPasswords {{ security_baseline_permit_empty_passwords }}

# Public key authentication
PubkeyAuthentication {{ security_baseline_pubkey_authentication }}
AuthorizedKeysFile .ssh/authorized_keys

# Challenge-response authentication
ChallengeResponseAuthentication no
KbdInteractiveAuthentication no

# Authentication limits
MaxAuthTries {{ security_baseline_max_auth_tries }}
LoginGraceTime {{ security_baseline_login_grace_time }}
MaxSessions 10
MaxStartups 10:30:60

{% if security_baseline_allow_users | length > 0 %}
# Allowed users
AllowUsers {{ security_baseline_allow_users | join(' ') }}
{% endif %}

# =============================================================================
# Session Configuration
# =============================================================================

# Client alive settings (prevent idle connections)
ClientAliveInterval {{ security_baseline_client_alive_interval }}
ClientAliveCountMax {{ security_baseline_client_alive_count_max }}

# Disable X11 forwarding
X11Forwarding {{ security_baseline_x11_forwarding }}

# Disable agent forwarding (can be enabled per-user if needed)
AllowAgentForwarding no
AllowTcpForwarding no

# Disable gateway ports
GatewayPorts no

# Disable tunneling
PermitTunnel no

# =============================================================================
# Logging Configuration
# =============================================================================
SyslogFacility AUTH
LogLevel VERBOSE

# Strict mode (check file permissions)
StrictModes yes

# Disable rhosts authentication
IgnoreRhosts yes

# Disable user environment variables
PermitUserEnvironment no

# Use PAM (for password policy enforcement)
UsePAM yes

# Banner message
Banner /etc/issue.net

# Print message of the day
PrintMotd yes
PrintLastLog yes

# =============================================================================
# SFTP Configuration
# =============================================================================
Subsystem sftp /usr/lib/openssh/sftp-server -f AUTHPRIV -l INFO

# =============================================================================
# Additional Security Options
# =============================================================================

# Compression (disable in production for security)
{% if security_baseline_environment == 'production' %}
Compression no
{% else %}
Compression delayed
{% endif %}

# Deny specific users (optional)
# DenyUsers *@192.168.0.*

# Deny groups (optional)
# DenyGroups nogroup

# TCP keep alive
TCPKeepAlive yes

# Disable DNS lookups
UseDNS no

# Accept only necessary environment variables
AcceptEnv LANG LC_*
